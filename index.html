    function updateUI() {
      const today = getToday();
      const history = loadUsage(); // Load the raw history first
      const thisWeekData = getCurrentWeek(history, today); // Get week structure with defaults

      // Calculate totalYes based on actual non-auto entries in history for the week
      const weekStartStr = getWeekStart(today);
      const weekStartDate = new Date(weekStartStr);
      let totalYes = 0;
      for (let i = 0; i < 7; i++) {
          const d = new Date(weekStartDate);
          d.setDate(weekStartDate.getDate() + i);
          const currentDayInWeekStr = d.toISOString().split("T")[0];
          if (currentDayInWeekStr > today) continue; // Don't count future days

          const entryInHistory = history.find(e => e.date === currentDayInWeekStr && !e.auto && e.result === "כן");
          if (entryInHistory) {
              totalYes++;
          }
      }


      const todayManualEntry = history.find(e => e.date === today && !e.auto);

      if (totalYes > 4) {
        document.getElementById("summary").innerText = `השבוע עשית ${totalYes} פעמים. המטרה היא עד 4.`;
      } else {
        document.getElementById("summary").innerText = `השבוע עשית ${totalYes} מתוך 4 מותרים.`;
      }

      // Update message based only on a manual entry for today
      document.getElementById("message").innerText = todayManualEntry ? `החלטת היום: ${todayManualEntry.result}` : "עדיין לא בחרת היום";

      const todayCard = document.getElementById("todayCard");
      if (!todayManualEntry) { // Pulse if no manual entry for today
        todayCard.style.animation = 'pulse 1.5s infinite';
      } else {
        todayCard.style.animation = 'none';
      }

      const historyList = document.getElementById("historyList");
      historyList.innerHTML = '';

      // Use the structured week data, but check against raw history for today's display
      thisWeekData.forEach(entry => {
          const div = document.createElement("div");
          div.classList.add("history-item");

          const entryDate = new Date(entry.date);
          entryDate.setHours(0,0,0,0);
          const todayDate = new Date(today);
          todayDate.setHours(0,0,0,0);

          let displayText = "";
          let isAuto = false; // Flag to handle styling

          // Find the *actual* manual entry from history for this date, if any
          const manualEntryForThisDate = history.find(h => h.date === entry.date && !h.auto);

          if (entry.date === today) {
              if (manualEntryForThisDate) {
                  displayText = manualEntryForThisDate.result; // Display manual choice: "כן" or "לא"
                  if (displayText === "כן") div.classList.add("history-yes");
                  else div.classList.add("history-no"); // Manual "לא"
              } else {
                  displayText = "לא בחרת עדיין"; // Specific text for today if no choice made
                  // No border color needed for this specific state, maybe add a unique class if desired
              }
          } else { // For past days
              if (manualEntryForThisDate) {
                  displayText = manualEntryForThisDate.result;
                   if (displayText === "כן") div.classList.add("history-yes");
                   else div.classList.add("history-no"); // Manual "לא"
              } else {
                  // If no manual entry for a past day, it defaults to auto 'לא'
                  displayText = "לא (אוטומטי)";
                  isAuto = true;
                  div.classList.add("history-auto");
              }
          }

          const dateResult = document.createElement("div");
          const dayName = new Date(entry.date).toLocaleDateString('he-IL', { weekday: 'long' });
          // Add "(ידני)" only if it was a manual 'לא'
          const manualNoSuffix = (manualEntryForThisDate && manualEntryForThisDate.result === "לא") ? " (ידני)" : "";
          dateResult.innerText = `${dayName} (${formatDate(entry.date)}): ${displayText}${manualNoSuffix}`;

          if (isAuto || (entry.date === today && !manualEntryForThisDate)) { // Dim text for auto entries and today's "לא בחרת עדיין"
              dateResult.classList.add("auto-entry"); // Use existing style for dimming
          }
          div.appendChild(dateResult);


          // Only show edit buttons for days strictly BEFORE today
          if (entryDate < todayDate) {
              const btnContainer = document.createElement("div");
              btnContainer.classList.add("day-buttons");

              const yesBtnPast = document.createElement("button");
              yesBtnPast.innerText = "כן";
              yesBtnPast.classList.add("btn-yes");
              yesBtnPast.onclick = () => updatePastDay(entry.date, "כן");

              const noBtnPast = document.createElement("button");
              noBtnPast.innerText = "לא";
              noBtnPast.classList.add("btn-no");
              noBtnPast.onclick = () => updatePastDay(entry.date, "לא");

              btnContainer.appendChild(yesBtnPast);
              btnContainer.appendChild(noBtnPast);
              div.appendChild(btnContainer);
          }
          historyList.appendChild(div);
      });


      // Disable today's buttons only if a manual entry exists
      document.getElementById("yesBtn").disabled = !!todayManualEntry;
      document.getElementById("noBtn").disabled = !!todayManualEntry;
      document.getElementById("decideBtn").disabled = !!todayManualEntry;
    }
