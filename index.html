<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>השליטה של רועי</title>
  <link href="https://fonts.googleapis.com/css2?family=Secular+One&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Secular One', sans-serif;
      background: #1c1f26;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .card {
      background-color: rgba(32,64,72,0.5);
      border-radius: 16px;
      padding: 20px;
      margin: 16px auto;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #4ea3a3;
      color: white;
      cursor: pointer;
      margin: 4px;
    }
    button:disabled {
      background: #888;
      cursor: not-allowed;
    }
    .auto-entry {
      opacity: 0.4;
    }
    .edit-buttons {
      margin-top: 6px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .history-item span {
      flex: 1;
      text-align: right;
    }
    .chart-container {
      position: relative;
      height: 250px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>שלום רועי!</h1>

  <div class="card">
    <p>מה תעשה היום?</p>
    <button id="yesBtn">כן, היום כן</button>
    <button id="noBtn">לא, היום לא</button>
    <button id="decideBtn">תחליט בשבילי</button>
  </div>

  <div class="card">
    <p id="summary"></p>
    <p id="message"></p>
  </div>

  <div class="card">
    <h3>היסטוריה שבועית</h3>
    <div id="historyList"></div>
  </div>

  <div class="card">
    <h3>פירוט שבועי (גרף)</h3>
    <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
  </div>

  <div class="card">
    <button onclick="confirmReset()">איפוס כל הנתונים</button>
  </div>

  <script>
    const usageKey = 'usage_history_v8';
    let weeklyChartInstance = null;

    function getToday() {
      const now = new Date();
      const iz = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Jerusalem"}));
      return iz.toISOString().split("T")[0];
    }
    function parseDate(d) { return new Date(d.split('-')[0], d.split('-')[1]-1, d.split('-')[2]); }
    function formatDate(d) {
      const dd = String(d.getDate()).padStart(2,'0'),
            mm = String(d.getMonth()+1).padStart(2,'0'),
            yy = d.getFullYear();
      return `${yy}-${mm}-${dd}`;
    }
    function addDays(d, n) { let x=new Date(d); x.setDate(x.getDate()+n); return x; }

    function getWeekStart(dateStr) {
      let d = parseDate(dateStr),
          w = d.getDay(), diff = (w + 5)%7;
      d.setDate(d.getDate()-diff);
      return formatDate(d);
    }

    function loadUsage() {
      return JSON.parse(localStorage.getItem(usageKey)||'[]');
    }
    function saveUsage(h) {
      localStorage.setItem(usageKey, JSON.stringify(h));
    }

    function getCurrentWeek(history, todayStr) {
      const start = parseDate(getWeekStart(todayStr)),
            today = parseDate(todayStr),
            week = [];
      for(let i=0;i<7;i++){
        const d = addDays(start,i),
              ds = formatDate(d),
              entry = history.find(e=>e.date===ds);
        if(entry) {
          entry.auto = false;
          week.push(entry);
        } else if(d<=today) {
          week.push({date:ds,result:'לא',auto:true});
        } else {
          week.push({date:ds,result:null,auto:true});
        }
      }
      return week;
    }

    function updateUI(){
      const today=getToday(),
            hist=loadUsage(),
            week=getCurrentWeek(hist,today),
            yesCount=week.filter(e=>e.result==='כן').length,
            todayEntry=hist.find(e=>e.date===today);
      document.getElementById('summary').innerText=`השבוע עשית ${yesCount} מתוך 4`;
      document.getElementById('message').innerText = todayEntry ? `החלטת היום: ${todayEntry.result}` : '';
      const list = document.getElementById('historyList');
      list.innerHTML='';
      week.slice().reverse().forEach(e=>{
        const row=document.createElement('div');
        row.className='history-item'+(e.auto?' auto-entry':'');
        const label=document.createElement('span');
        const [y,m,d]=e.date.split('-');
        label.innerText=`${d}.${m} : ${e.result||''}`;
        row.appendChild(label);
        if(e.auto && e.result!=='כן' && e.result!=='לא'){
          const btns=document.createElement('div');
          btns.className='edit-buttons';
          ['כן','לא'].forEach(rx=>{
            const b=document.createElement('button');
            b.innerText=rx;
            b.onclick=()=>{ editPast(e.date,rx); };
            btns.appendChild(b);
          });
          row.appendChild(btns);
        }
        list.appendChild(row);
      });
      ['yesBtn','noBtn','decideBtn'].forEach(id=>{
        document.getElementById(id).disabled = !!todayEntry;
      });
    }

    function canSmoke() {
      const today=getToday(),
            hist=loadUsage().filter(e=>!e.auto),
            wk=getCurrentWeek(hist,today),
            yes=wk.filter(e=>e.result==='כן').length,
            last2=wk.filter(e=>e.result==='כן').slice(-2);
      return yes<4 && last2.length<2;
    }

    function addEntry(res){
      const today=getToday(), hist=loadUsage();
      if(hist.find(e=>e.date===today)) return;
      if(res==='כן' && !canSmoke()){ alert('אי אפשר היום'); return; }
      hist.push({date:today,result:res});
      saveUsage(hist);
      updateUI(); renderChart();
    }

    function editPast(dateStr,res){
      const hist=loadUsage();
      hist.push({date:dateStr,result:res});
      saveUsage(hist);
      updateUI(); renderChart();
    }

    function renderChart(){
      if(weeklyChartInstance) weeklyChartInstance.destroy();
      const today=getToday(),
            start=parseDate(getWeekStart(today)),
            hist=loadUsage(),
            week=getCurrentWeek(hist,today),
            labels=["שלישי","רביעי","חמישי","שישי","שבת","ראשון","שני"],
            yesData=[], noData=[];
      for(let i=0;i<7;i++){
        const d=addDays(start,i), ds=formatDate(d),
              e=week.find(x=>x.date===ds);
        yesData.push(e&&e.result==='כן'?1:0);
        noData.push(e&&e.result==='לא'?1:0);
      }
      weeklyChartInstance = new Chart(
        document.getElementById('weeklyChart'),
        {
          type:'bar',
          data:{labels,datasets:[
            {label:'כן',data:yesData,backgroundColor:'rgba(76,175,80,0.7)',barPercentage:0.6,categoryPercentage:0.6},
            {label:'לא',data:noData,backgroundColor:'rgba(244,67,54,0.7)',barPercentage:0.6,categoryPercentage:0.6}
          ]},
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'}},
            scales:{
              x:{grid:{display:false}},
              y:{beginAtZero:true,max:1,ticks:{stepSize:1,callback:v=>v===1?'✔':''},grid:{display:false}}
            }
          }
        }
      );
    }

    function confirmReset(){
      if(confirm('לאפס את כל הנתונים?')){
        localStorage.removeItem(usageKey);
        updateUI(); renderChart();
      }
    }

    document.getElementById('yesBtn').onclick=()=>addEntry('כן');
    document.getElementById('noBtn').onclick=()=>addEntry('לא');
    document.getElementById('decideBtn').onclick=()=>addEntry(canSmoke()? (Math.random()<0.5?'כן':'לא') : 'לא');

    updateUI(); renderChart();
  </script>
</body>
</html>
